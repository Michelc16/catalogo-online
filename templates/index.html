<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Produtos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .product-image {
            height: 200px;
            object-fit: cover;
            width: 100%;
        }
        .category-filter .btn {
            margin: 2px;
        }
        .price-tag {
            font-size: 1.25rem;
            font-weight: bold;
            color: #28a745;
        }
        .no-image {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-store"></i> Catálogo Online
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin">
                    <i class="fas fa-cog"></i> Área Admin
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">Nossos Produtos</h1>
                
                <div class="category-filter text-center mb-4">
                    <button class="btn btn-outline-primary active" data-category="all">Todos</button>
                    <!-- Categorias serão carregadas dinamicamente -->
                </div>

                <!-- Barra de Pesquisa -->
                <div class="row mb-4">
                    <div class="col-md-6 mx-auto">
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-input" placeholder="Pesquisar produtos...">
                            <button class="btn btn-outline-secondary" type="button" id="search-button">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="clear-search" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="row" id="products-container">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2">Carregando produtos...</p>
                    </div>
                </div>

                <!-- Mensagem quando não há produtos -->
                <div id="no-products" class="text-center" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <h4>Nenhum produto encontrado</h4>
                        <p>Tente alterar os filtros de pesquisa ou categoria.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalhes do produto -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Detalhes do Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="productModalBody">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white mt-5 py-4">
        <div class="container text-center">
            <p>&copy; 2024 Catálogo Online. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = window.location.origin + '/api';
        let allProducts = [];
        let currentCategory = 'all';
        let currentSearch = '';

        // Carregar produtos
        async function loadProducts() {
            try {
                showLoading();
                
                const response = await fetch(`${API_BASE}/products`);
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar produtos');
                }
                
                allProducts = await response.json();
                displayProducts(allProducts);
                loadCategories(allProducts);
                
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('products-container').innerHTML = `
                    <div class="col-12 text-center">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            Erro ao carregar produtos: ${error.message}
                        </div>
                        <button class="btn btn-primary" onclick="loadProducts()">
                            <i class="fas fa-redo"></i> Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        // Mostrar loading
        function showLoading() {
            document.getElementById('products-container').innerHTML = `
                <div class="col-12 text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando produtos...</p>
                </div>
            `;
            document.getElementById('no-products').style.display = 'none';
        }

        // Exibir produtos
        function displayProducts(products) {
            const container = document.getElementById('products-container');
            const noProducts = document.getElementById('no-products');
            
            if (products.length === 0) {
                container.innerHTML = '';
                noProducts.style.display = 'block';
                return;
            }
            
            noProducts.style.display = 'none';
            
            container.innerHTML = products.map(product => `
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="card product-card h-100">
                        <div class="card-img-top product-image ${!product.image_exists ? 'no-image' : ''}">
                            ${product.image_exists ? 
                                `<img src="${API_BASE.replace('/api', '')}/uploads/${product.image_url}" 
                                      class="product-image" 
                                      alt="${product.name}"
                                      onerror="this.style.display='none'; this.parentElement.classList.add('no-image'); this.parentElement.innerHTML='<i class=\\'fas fa-image\\'></i>'">` :
                                `<i class="fas fa-image"></i>`
                            }
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${escapeHtml(product.name)}</h5>
                            ${product.description ? `<p class="card-text flex-grow-1">${escapeHtml(product.description.substring(0, 100))}${product.description.length > 100 ? '...' : ''}</p>` : ''}
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="price-tag">R$ ${product.price.toFixed(2)}</span>
                                    ${product.category ? `<span class="badge bg-primary">${escapeHtml(product.category)}</span>` : ''}
                                </div>
                                <button class="btn btn-outline-primary w-100 mt-2" onclick="showProductDetails(${product.id})">
                                    <i class="fas fa-eye"></i> Ver Detalhes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Carregar categorias
        function loadCategories(products) {
            const categories = [...new Set(products.map(p => p.category).filter(c => c))];
            const filterContainer = document.querySelector('.category-filter');
            
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'btn btn-outline-primary';
                button.textContent = category;
                button.setAttribute('data-category', category);
                button.onclick = () => filterByCategory(category);
                filterContainer.appendChild(button);
            });
        }

        // Filtrar por categoria
        function filterByCategory(category) {
            currentCategory = category;
            
            // Atualizar botões ativos
            document.querySelectorAll('.category-filter .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.category-filter .btn[data-category="${category}"]`).classList.add('active');
            
            applyFilters();
        }

        // Aplicar filtros
        function applyFilters() {
            let filteredProducts = allProducts;
            
            // Filtrar por categoria
            if (currentCategory !== 'all') {
                filteredProducts = filteredProducts.filter(product => product.category === currentCategory);
            }
            
            // Filtrar por pesquisa
            if (currentSearch) {
                const searchTerm = currentSearch.toLowerCase();
                filteredProducts = filteredProducts.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm)) ||
                    (product.category && product.category.toLowerCase().includes(searchTerm))
                );
            }
            
            displayProducts(filteredProducts);
        }

        // Pesquisar produtos
        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const clearButton = document.getElementById('clear-search');
            
            searchButton.addEventListener('click', () => {
                currentSearch = searchInput.value.trim();
                applyFilters();
                clearButton.style.display = currentSearch ? 'block' : 'none';
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    currentSearch = searchInput.value.trim();
                    applyFilters();
                    clearButton.style.display = currentSearch ? 'block' : 'none';
                }
            });
            
            clearButton.addEventListener('click', () => {
                searchInput.value = '';
                currentSearch = '';
                applyFilters();
                clearButton.style.display = 'none';
            });
        }

        // Mostrar detalhes do produto
        async function showProductDetails(productId) {
            try {
                const response = await fetch(`${API_BASE}/products/${productId}`);
                
                if (!response.ok) {
                    throw new Error('Produto não encontrado');
                }
                
                const product = await response.json();
                
                document.getElementById('productModalTitle').textContent = product.name;
                document.getElementById('productModalBody').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="text-center mb-3">
                                ${product.image_exists ? 
                                    `<img src="${API_BASE.replace('/api', '')}/uploads/${product.image_url}" 
                                          class="img-fluid rounded" 
                                          alt="${product.name}"
                                          style="max-height: 300px; object-fit: cover;">` :
                                    `<div class="no-image rounded" style="height: 300px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-image fa-3x"></i>
                                    </div>`
                                }
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4 class="text-success">R$ ${product.price.toFixed(2)}</h4>
                            ${product.category ? `<p><strong>Categoria:</strong> <span class="badge bg-primary">${escapeHtml(product.category)}</span></p>` : ''}
                            ${product.description ? `<p><strong>Descrição:</strong><br>${escapeHtml(product.description)}</p>` : ''}
                            <p><small class="text-muted">ID: #${product.id}</small></p>
                        </div>
                    </div>
                `;
                
                new bootstrap.Modal(document.getElementById('productModal')).show();
                
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                alert('Erro ao carregar detalhes do produto');
            }
        }

        // Função auxiliar para escapar HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            setupSearch();
        });
    </script>
</body>
</html>